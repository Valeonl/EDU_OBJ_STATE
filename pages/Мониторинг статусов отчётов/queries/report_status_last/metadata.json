{
  "gitSyncId": "6790a0cc8b895701c38ce700_436c936a-f6c6-4cda-b449-1559e4b4d3e0",
  "id": "Мониторинг статусов отчётов_report_status_last",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH latest_status AS (\n\tSELECT \n\trsh.directory_inn_id,\n\tMAX(rsh.created_date) AS max_date\n\tFROM \n\tappsmith.report_status_history_mat_view rsh\n\tGROUP BY \n\trsh.directory_inn_id\n)\nSELECT DISTINCT ON (rsh.directory_inn_id)\n    di.inn AS \"ИНН\",\n    di.short_name AS \"Наименование учреждения\",\n    rs.print_name AS \"Статус\",\n    rs.system_name AS status_system_name,\t\t\n\t\tiogv.inn AS \"ИОГВ ИНН\",\n    iogv.short_name AS \"ИОГВ\", -- Краткое название ИОГВ\n    to_char(rsh.created_date + INTERVAL '3 hours', 'DD.MM.YYYY HH24:MI') AS \"Дата\",\n    CASE \n        WHEN rs.system_name IN ('under_iogv_review', 'sent_for_review') THEN \n            DATE_PART('day', AGE(CURRENT_DATE, rsh.created_date::date))\n        ELSE \n            NULL\n    END AS \"Ждет проверки, дн.\",\n    rsh.directory_inn_id\nFROM \n    appsmith.report_status_history_mat_view rsh\nLEFT JOIN \n    appsmith.directory_inn di ON rsh.directory_inn_id = di.directory_inn_id\n\t\tLEFT JOIN \n    appsmith.directory_inn iogv ON di.iogv_inn::text = iogv.inn::text -- Соединение для получения краткого названия ИОГВ\nLEFT JOIN \n    appsmith.status rs ON rsh.status_id = rs.status_id\nINNER JOIN \n    latest_status ls ON rsh.directory_inn_id = ls.directory_inn_id AND rsh.created_date = ls.max_date\nINNER JOIN \n    appsmith.report_directory_inn rdi ON rsh.directory_inn_id = rdi.directory_inn_id -- Привязка к report_directory_inn\nWHERE \n    rdi.report_id = {{ appsmith.store.selected_report.report_id }} -- Условие для фильтрации по report_id\n    AND ({{ appsmith.store.superuser.group_system_name === 'ko_employee' ? 'true' : `di.iogv_inn = '${appsmith.store.superuser.ou_inn}'`}})\n    AND di.directory_inn_finance_type_id = 2\t\t\t\n\t\tAND di.directory_inn_type_id != 2 AND di.directory_inn_type_id != 7\n\t\tAND ({{ appsmith.store.superuser.ou_inn === '999999999' ? 'true' : `di.iogv_inn != 999999999`}})\n    AND ({{ monitoring_select_inn.selectedOptionValue ? `di.inn::text = '${monitoring_select_inn.selectedOptionValue}'` : 'true' }})\n    AND ({{ monitoring_status_filter_selec.selectedOptionValue ? `rs.print_name::text = '${monitoring_status_filter_selec.selectedOptionValue}'` : 'true' }})\n\t\tAND ({{ monitoring_select_iogv.selectedOptionValue ? `iogv.inn ::text = '${monitoring_select_iogv.selectedOptionValue}'` : 'true' }})\nORDER BY \n    rsh.directory_inn_id, rsh.created_date DESC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Appsmith CAD",
      "isAutoGenerated": false,
      "name": "Appsmith CAD",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "executeOnLoad": true,
    "name": "report_status_last",
    "pageId": "Мониторинг статусов отчётов",
    "userSetOnLoad": false
  }
}